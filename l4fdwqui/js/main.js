function initialize(){$("#ArmyMap").css("width",winWidth),$("#ArmyMap").css("height",winHeight+120),maphandler=new BMap.Map("ArmyMap",{mapType:BMAP_SATELLITE_MAP}),maphandler.centerAndZoom(new BMap.Point(geoinfo.Longitude,geoinfo.Latitude),15),maphandler.enableScrollWheelZoom();var e=new BMap.TileLayer;e.getTilesUrl=function(e,l){var t=(e.x,e.y,"http://127.0.0.1/army/image/black.png");return t},maphandler.addTileLayer(e)}function initialize_statistic(){var e="<div><p class='alarmtext' style='font-size:24px;'><span class='alarmtext'>战场统计</span></p>";e+="<p class='maintext'>战力指示: 90%</p>",e+="<p class='maintext'>资源指示: 95%</p>",e+="<p class='maintext'>负载指示: 85%</p>",e+="<p class='maintext'>救治指示: 92%</p>",$("#MainStatistic").empty(),$("#MainStatistic").append(e)}function initialize_guild(e){var l="";0!=e.error?(l+="<li><div><p class='maintext' style='font-size:48px;text-align:center;'><i class='fa fa-empire' ></i></p></div>",l+="<p class='maintext'>获取天气失败</p>",l+="<p class='maintext'><a class='pull-right'><span class='maintext'>more</span></a></p>",l+="</li>"):(l+="<li><div><p class='maintext' style='font-size:48px;text-align:center;'><i class='fa fa-empire' ></i></p></div>",l=l+"<p class='maintext'>天气：  "+e.results[0].weather_data[0].weather+"</p>",l=l+"<p class='maintext'>气温：  "+e.results[0].weather_data[0].temperature+"</p>",l=l+"<p class='maintext'>颗粒物： "+e.results[0].pm25+"</p>",l+="<p class='maintext'><a class='pull-right'><span class='maintext'>more</span></a></p>",l+="</li>"),$("#MainGuild").empty(),$("#MainGuild").append(l)}function initialize_config(){var e="";e+="<li><div><p class='maintext' style='font-size:24px;'><i class='fa fa-cog' ></i><span class='maintext'>系统配置</span></p></div>",e+="</li>",$("#SysConfig").empty(),$("#SysConfig").append(e)}function initialize_note(){var e="";e+="<li><div><p class='maintext' style='font-size:24px;'><i class='fa fa-flag' ></i><span class='maintext'>图标说明</span></p></div>",e+="<p class='maintext'><img src='./image/heath_small.png' style='width:16px;hight:16px'></img><span class='maintext' style='margin-left: 25px'>士兵</span></p>",e+="<p class='maintext'><img src='./image/wounded_small.png' style='width:16px;hight:16px'></img><span class='maintext' style='margin-left: 25px'>伤员</span></p>",e+="<p class='maintext'><img src='./image/treated_small.png' style='width:16px;hight:16px'></img><span class='maintext' style='margin-left: 25px'>已治疗</span></p>",e+="<p class='maintext'><img src='./image/injury_small.png' style='width:16px;hight:16px'></img><span class='maintext' style='margin-left: 25px'>重伤</span></p>",e+="<p class='maintext'><img src='./image/dead_small.png' style='width:16px;hight:16px'></img><span class='maintext' style='margin-left: 25px'>死亡</span></p>",e+="<p class='maintext'><img src='./image/ambulance_small.png' style='width:16px;hight:16px'></img><span class='maintext' style='margin-left: 25px'>救护车</span></p>",e+="<p class='maintext'><img src='./image/hospital.png' style='width:24px;hight:24px'></img><span class='maintext' style='margin-left: 17px'>医疗点</span></p>",e+="<p class='maintext'><img src='./image/line_small.png' style='width:16px;hight:16px'></img><span class='maintext' style='margin-left: 25px'>救治路线</span></p>",e+="</li>",$("#MainNote").empty(),$("#MainNote").append(e)}function get_size(){window.innerWidth?winWidth=window.innerWidth:document.body&&document.body.clientWidth&&(winWidth=document.body.clientWidth),window.innerHeight?winHeight=window.innerHeight:document.body&&document.body.clientHeight&&(winHeight=document.body.clientHeight),document.documentElement&&document.documentElement.clientHeight&&document.documentElement.clientWidth&&(winHeight=document.documentElement.clientHeight,winWidth=document.documentElement.clientWidth),console.log("winWidth = "+winWidth),console.log("winHeight= "+winHeight)}function getLocation(){var e=new BMap.Map("GuildMap"),l=new BMap.Point(116.501573,39.900877);e.centerAndZoom(l,15);var t=new BMap.Geocoder,a=new BMap.Geolocation;a.getCurrentPosition(function(e){if(this.getStatus()==BMAP_STATUS_SUCCESS){var l={latitude:e.point.lat,longitude:e.point.lng},a={coords:l};geoinfo=showPosition(a),t.getLocation(new BMap.Point(geoinfo.Longitude,geoinfo.Latitude),function(e){console.log(e);var l=e.addressComponents,t=l.city;console.log("favorate city is "+t),get_pm(t)}),initialize()}else console.log("无法获得当前位置！"),alert("无法获得当前位置！")},{enableHighAccuracy:!0})}function showPosition(e){return console.log("Latitude: "+e.coords.latitude+"Longitude: "+e.coords.longitude),{Latitude:e.coords.latitude,Longitude:e.coords.longitude}}function get_pm(e){var l=e,t="http://api.map.baidu.com/telematics/v3/weather?location="+l+"&output=json&ak=2Pcn24FAWGTcyW4jsC8O38IyPd0pDZYX";$.ajax({url:t,scriptCharset:"gbk",dataType:"jsonp",crossDomain:!0,success:function(e){console.log(e),initialize_guild(e)}})}function get_city(e,l){var t=new BMap.Point(l,e),a=new BMap.Geocoder;a.getLocation(t,function(e){var l=e.addressComponents;console.log(e.addressComponents);var t=l.city;console.log("favorate city is "+t),get_pm(t)})}function initialize_mqtt(){client=mqtt.connect("ws://127.0.0.1:3000/mqtt",{username:"username",password:"password",clientId:"MQTT_XH_ARMY_UI_Main"}),client.on("connect",function(){console.log("mqtt connect :)"),client.subscribe("MQTT_XH_ARMY_UI_Main")}),client.on("error",function(e){console.log(e.toString()),window.alert("Lost connect to hcu, please contact administrator!")}),client.on("message",function(e,l){var t=JSON.parse(l.toString());switch(t.action){case"XH_ARMY_MEDICAL_SOLDIER_INFO":render_soldier(t.body);break;case"XH_ARMY_MEDICAL_HOSPITAL_INFO":render_hospital(t.body);break;case"XH_ARMY_MEDICAL_AMBULANCE_INFO":render_ambulance(t.body);break;default:return}})}function render_all(e){render_soldier(e.soldier.soldierinfo)}function settoplabel(e){for(var l=0;l<labellist.length;l++)labellist[l].key==e?labellist[l].label.setZIndex(99):labellist[l].label.setZIndex(1)}function setdownlabel(){for(var e=0;e<labellist.length;e++)labellist[e].label.setStyle({zIndex:"1"})}function search_label(e){for(var l=null,t=0;t<labellist.length;t++)labellist[t].key==e&&(l=labellist[t].label);return l}function remove_label(e){for(var l=0;l<labellist.length;l++)if(labellist[l].key==e){var t=labellist[l].label;return labellist.splice(l,1),void maphandler.removeOverlay(t)}}function render_soldier(e){console.log(e),soldierlist=e,null!==maphandler&&(addsoldier(e),flash_soldier_label(soldierlist))}function render_hospital(e){console.log("0"),hospitallist=e,console.log("length:"+e.length),console.log("length:"+hospitallist.length),console.log(hospitallist),null!==maphandler&&(addhospital(e),flash_hospital_label(hospitallist))}function render_ambulance(e){ambulancelist=e,null!==maphandler&&(addambulance(e),flash_ambulance_label(ambulancelist))}function make_soldier_label_key(e){return"Soldier_"+e.id+"_"+e.Name}function flash_soldier_label(e){for(var l=0;l<e.length;l++){var t=search_label(make_soldier_label_key(e[l]));null!==t&&(console.log("find open label, key="+make_soldier_label_key(e[l])),soldierselected=e[l],buildsoldierlabel())}}function get_select_soldier(e){for(var l=e.split(":"),t=0;t<soldierlist.length;t++)if(soldierlist[t].id==l[0])return void(soldierselected=soldierlist[t]);soldierselected=null}function removesoldiermarker(e){for(var l=0;l<soldiermarklist.length;l++)if(soldiermarklist[l].getTitle()==e){var t=soldiermarklist[l];soldiermarklist.splice(l,1),maphandler.removeOverlay(t)}}function buildsoldierlabel(){if(null===soldierselected)return null;var e,l=search_label("Soldier_"+soldierselected.id+"_"+soldierselected.Name),t="";if(null===l){for(console.log("SHow label"),t="<div style='padding: 10px;min-width:150px'><div class='pull-left' style='margin-top:5px'><b class='maintext' style='font-size: 18px;font-weight: bold'>战斗单位</b></div><div class='pull-right' style='margin-top: -5px;margin-right: -7px'><a class='maintext label_close_button'  id='Soldier_"+soldierselected.id+"_"+soldierselected.Name+"' >[x]</a></div><li id='Soldier_"+soldierselected.id+"_"+soldierselected.Name+"_Content' style='margin-top: 10px;'><div><p class='maintext'>id:"+soldierselected.id+"</p>",t=t+"<p class='maintext'>name:"+soldierselected.Name+"</p>",t+="<p class='maintext'>详细信息：</p>",e=0;e<soldierselected.detailinfo.length;e++)t=t+"<p class='maintext'>"+soldierselected.detailinfo[e].name+":"+soldierselected.detailinfo[e].detail+"</p>";t+="</div></li></div>",l=new BMap.Label(t,{offset:new BMap.Size(24,(-32)),position:new BMap.Point(parseFloat(soldierselected.Longitude),parseFloat(soldierselected.Latitude))}),l.setStyle({fontSize:"14px",border:"0",textAlign:"left",lineHeight:"10px",background:"#000000",opacity:.8}),l.addEventListener("click",function(){console.log("click on soldier_label"),setdownlabel(),this.setStyle({zIndex:"100"})}),maphandler.addOverlay(l),labellist.push({key:"Soldier_"+soldierselected.id+"_"+soldierselected.Name,label:l}),$(".label_close_button").on("click",function(){var e=$(this).attr("id");console.log("close button click"),remove_label(e)})}else{for(l.setPosition(new BMap.Point(parseFloat(soldierselected.Longitude),parseFloat(soldierselected.Latitude))),console.log("flash label"),t="<div><p class='maintext'>id:"+soldierselected.id+"</p>",t=t+"<p class='maintext'>name:"+soldierselected.Name+"</p>",t+="<p class='maintext'>详细信息：</p>",e=0;e<soldierselected.detailinfo.length;e++)t=t+"<p class='maintext'>"+soldierselected.detailinfo[e].name+":"+soldierselected.detailinfo[e].detail+"</p>";t+="</div>",$("#Soldier_"+soldierselected.id+"_"+soldierselected.Name+"_Content").empty(),$("#Soldier_"+soldierselected.id+"_"+soldierselected.Name+"_Content").append(t)}}function addsoldier(e){soldier_mark_click=function(){get_select_soldier(this.getTitle()),null!=soldierselected&&buildsoldierlabel()};for(var l=0;l<soldierlist.length;l++){var t;switch(soldierlist[l].status){case"HEATH":t=new BMap.Icon("./image/heath_small.png",new BMap.Size(16,16));break;case"DEAD":t=new BMap.Icon("./image/dead_small.png",new BMap.Size(16,16));break;case"TREATED":t=new BMap.Icon("./image/treated_small.png",new BMap.Size(16,16));break;case"INJURY":t=new BMap.Icon("./image/injury_small.png",new BMap.Size(16,16));break;case"WOUNDED":t=new BMap.Icon("./image/wounded_small.png",new BMap.Size(16,16));break;default:return}var a=new BMap.Point(parseFloat(soldierlist[l].Longitude),parseFloat(soldierlist[l].Latitude)),i=new BMap.Marker(a,{icon:t,zIndex:10});i.setTop(!0),i.setTitle(soldierlist[l].id+":"+soldierlist[l].Name),removesoldiermarker(soldierlist[l].id+":"+soldierlist[l].Name),maphandler.addOverlay(i),i.addEventListener("click",soldier_mark_click),soldiermarklist.push(i)}}function make_hospital_label_key(e){return"Hospital_"+e.id+"_"+e.Name}function flash_hospital_label(e){for(var l=0;l<e.length;l++){var t=search_label(make_hospital_label_key(e[l]));null!==t&&(console.log("find open label, key="+make_hospital_label_key(e[l])),hospitalselected=e[l],buildhospitallabel())}}function get_select_hospital(e){for(var l=e.split(":"),t=0;t<hospitallist.length;t++)if(hospitallist[t].id==l[0])return void(hospitalselected=hospitallist[t]);hospitalselected=null}function removehospitalmarker(e){for(var l=0;l<hospitalmarklist.length;l++)if(hospitalmarklist[l].getTitle()==e){var t=hospitalmarklist[l];hospitalmarklist.splice(l,1),maphandler.removeOverlay(t)}}function buildhospitallabel(){if(null===hospitalselected)return null;var e,l=search_label("Hospital_"+hospitalselected.id+"_"+hospitalselected.Name),t="";if(null===l){for(console.log("SHow label"),t="<div style='padding: 10px;min-width:150px'><div class='pull-left' style='margin-top:5px'><b class='maintext' style='font-size: 18px;font-weight: bold'>战地医院</b></div><div class='pull-right' style='margin-top: -5px;margin-right: -7px'><a class='maintext label_close_button'  id='Hospital_"+hospitalselected.id+"_"+hospitalselected.Name+"' >[x]</a></div><li id='Hospital_"+hospitalselected.id+"_"+hospitalselected.Name+"_Content' style='margin-top: 10px;'><div><p class='maintext'>id:"+hospitalselected.id+"</p>",t=t+"<p class='maintext'>name:"+hospitalselected.Name+"</p>",t+="<p class='maintext'>详细信息：</p>",e=0;e<hospitalselected.detailinfo.length;e++)t=t+"<p class='maintext'>"+hospitalselected.detailinfo[e].name+":"+hospitalselected.detailinfo[e].detail+"</p>";t+="</div></li></div>",l=new BMap.Label(t,{offset:new BMap.Size(24,(-32)),position:new BMap.Point(parseFloat(hospitalselected.Longitude),parseFloat(hospitalselected.Latitude))}),l.setStyle({fontSize:"14px",border:"0",textAlign:"left",lineHeight:"10px",background:"#000000",opacity:.8}),maphandler.addOverlay(l),labellist.push({key:"Hospital_"+hospitalselected.id+"_"+hospitalselected.Name,label:l}),$(".label_close_button").on("click",function(){var e=$(this).attr("id");console.log("close button click"),remove_label(e)})}else{for(l.setPosition(new BMap.Point(parseFloat(hospitalselected.Longitude),parseFloat(hospitalselected.Latitude))),console.log("flash label"),t="<div><p class='maintext'>id:"+hospitalselected.id+"</p>",t=t+"<p class='maintext'>name:"+hospitalselected.Name+"</p>",t+="<p class='maintext'>详细信息：</p>",e=0;e<hospitalselected.detailinfo.length;e++)t=t+"<p class='maintext'>"+hospitalselected.detailinfo[e].name+":"+hospitalselected.detailinfo[e].detail+"</p>";t+="</div>",$("#Hospital_"+hospitalselected.id+"_"+hospitalselected.Name+"_Content").empty(),$("#Hospital_"+hospitalselected.id+"_"+hospitalselected.Name+"_Content").append(t)}}function addhospital(e){var l=new BMap.Icon("./image/hospital.png",new BMap.Size(32,32));hospital_mark_click=function(){get_select_hospital(this.getTitle()),null!=hospitalselected&&buildhospitallabel()};for(var t=0;t<hospitallist.length;t++){var a=new BMap.Point(parseFloat(hospitallist[t].Longitude),parseFloat(hospitallist[t].Latitude)),i=new BMap.Marker(a,{icon:l,zIndex:30});i.setTitle(hospitallist[t].id+":"+hospitallist[t].Name),i.setZIndex(20),removehospitalmarker(hospitallist[t].id+":"+hospitallist[t].Name),maphandler.addOverlay(i),i.addEventListener("click",hospital_mark_click),hospitalmarklist.push(i)}}function make_ambulance_label_key(e){return"Ambulance_"+e.id+"_"+e.Name}function flash_ambulance_label(e){for(var l=0;l<e.length;l++){var t=search_label(make_ambulance_label_key(e[l]));null!==t&&(console.log("find open label, key="+make_ambulance_label_key(e[l])),ambulanceselected=e[l],buildambulancelabel())}}function get_select_ambulance(e){for(var l=e.split(":"),t=0;t<ambulancelist.length;t++)if(ambulancelist[t].id==l[0])return void(ambulanceselected=ambulancelist[t]);ambulanceselected=null}function removeambulancemarker(e){for(var l=0;l<ambulancemarklist.length;l++)if(ambulancemarklist[l].marker.getTitle()==e){var t=ambulancemarklist[l];ambulancemarklist.splice(l,1),maphandler.removeOverlay(t.marker),maphandler.removeOverlay(t.linehandlerlist)}}function buildambulancelabel(){if(null===ambulanceselected)return null;var e,l=search_label("Ambulance_"+ambulanceselected.id+"_"+ambulanceselected.Name),t="";if(null===l){for(console.log("SHow label"),t="<div style='padding: 10px;min-width:150px'><div class='pull-left' style='margin-top:5px'><b class='maintext' style='font-size: 18px;font-weight: bold'>救护单位</b></div><div class='pull-right' style='margin-top: -5px;margin-right: -7px'><a class='maintext label_close_button'  id='Ambulance_"+ambulanceselected.id+"_"+ambulanceselected.Name+"' >[x]</a></div><li id='Ambulance_"+ambulanceselected.id+"_"+ambulanceselected.Name+"_Content' style='margin-top: 10px;'><div><p class='maintext'>id:"+ambulanceselected.id+"</p>",t=t+"<p class='maintext'>name:"+ambulanceselected.Name+"</p>",t+="<p class='maintext'>详细信息：</p>",e=0;e<ambulanceselected.detailinfo.length;e++)t=t+"<p class='maintext'>"+ambulanceselected.detailinfo[e].name+":"+ambulanceselected.detailinfo[e].detail+"</p>";t+="</div></li></div>",l=new BMap.Label(t,{offset:new BMap.Size(24,(-32)),position:new BMap.Point(parseFloat(ambulanceselected.Longitude),parseFloat(ambulanceselected.Latitude))}),l.setStyle({fontSize:"14px",border:"0",textAlign:"left",lineHeight:"10px",background:"#000000",opacity:.8}),maphandler.addOverlay(l),labellist.push({key:"Ambulance_"+ambulanceselected.id+"_"+ambulanceselected.Name,label:l}),$(".label_close_button").on("click",function(){var e=$(this).attr("id");console.log("close button click"),remove_label(e)})}else{for(l.setPosition(new BMap.Point(parseFloat(ambulanceselected.Longitude),parseFloat(ambulanceselected.Latitude))),console.log("flash label"),t="<div><p class='maintext'>id:"+ambulanceselected.id+"</p>",t=t+"<p class='maintext'>name:"+ambulanceselected.Name+"</p>",t+="<p class='maintext'>详细信息：</p>",e=0;e<ambulanceselected.detailinfo.length;e++)t=t+"<p class='maintext'>"+ambulanceselected.detailinfo[e].name+":"+ambulanceselected.detailinfo[e].detail+"</p>";t+="</div>",$("#Ambulance_"+ambulanceselected.id+"_"+ambulanceselected.Name+"_Content").empty(),$("#Ambulance_"+ambulanceselected.id+"_"+ambulanceselected.Name+"_Content").append(t)}}function addambulance(e){ambulance_mark_click=function(){get_select_ambulance(this.getTitle()),null!=ambulanceselected&&buildambulancelabel()};for(var l=0;l<ambulancelist.length;l++){var t=new BMap.Icon("./image/ambulance_small.png",new BMap.Size(16,16)),a=new BMap.Point(parseFloat(ambulancelist[l].Longitude),parseFloat(ambulancelist[l].Latitude)),i=new BMap.Marker(a,{icon:t,zIndex:40});i.setTitle(ambulancelist[l].id+":"+ambulancelist[l].Name),removeambulancemarker(ambulancelist[l].id+":"+ambulancelist[l].Name),i.setZIndex({zIndex:30}),maphandler.addOverlay(i),i.addEventListener("click",ambulance_mark_click);for(var n=[],s=0;s<ambulancelist[l].router.length;s++)n.push(new BMap.Point(parseFloat(ambulancelist[l].router[s].Longitude),parseFloat(ambulancelist[l].router[s].Latitude)));var o=new BMap.Polyline(n,{strokeColor:"#ADFF2F",strokeWeight:3,strokeOpacity:1});maphandler.addOverlay(o),ambulancemarklist.push({marker:i,linehandlerlist:o})}}var geoinfo={Longitude:null,Latitude:null},client,winWidth,winHeight,maphandler=null,soldierlist=[],hospitallist=[],ambulancelist=[],soldierselected=null,hospitalselected=null,ambulanceselected=null,soldierwindowhandler=null,hospitalwindowhandler=null,ambulancewindowhandler=null,soldiermarklist=[],hospitalmarklist=[],ambulancemarklist=[],labellist=[],sysinit=!1;$(document).ready(function(){get_size(),geoinfo=getLocation(),document.documentElement.style.overflow="hidden"}),window.onload=function(){initialize_statistic(),initialize_config(),initialize_note(),initialize_mqtt(),$(".label_close_button").on("click",function(){$(this).attr("id");console.log("close button click"),remove_label(hospital_label)})};